
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 文件圖片網址提取器 (普普風版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fef3c7; /* yellow-200 */
        }
        .font-pop {
            font-family: 'Bangers', cursive;
            letter-spacing: 0.05em;
        }
        .pop-shadow {
            box-shadow: 8px 8px 0px rgba(0,0,0,1);
        }
        .pop-shadow-sm {
            box-shadow: 4px 4px 0px rgba(0,0,0,1);
        }
        /* 載入中動畫 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #06b6d4; /* cyan-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-black">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">

        <header class="text-center mb-12">
            <h1 class="text-6xl sm:text-6xl font-bold text-yellow-300" style="text-shadow: 3px 3px 0px #ef4444, 6px 6px 0px #000;">Google 文件圖片網址提取器!</h1>
            <p class="mt-2 text-lg font-bold">貼上 Google 文件網址，剩下的交給我！</p>
        </header>

        <div class="bg-pink-400 p-6 border-4 border-black rounded-xl pop-shadow mb-12">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="url" id="gdoc-url" placeholder="https://docs.google.com/document/d/e/.../pub" class="flex-grow p-3 border-2 border-black rounded-lg text-lg focus:ring-4 focus:ring-yellow-300 focus:border-black transition duration-150 ease-in-out" required>
                <button onclick="extractImages()" class="font-pop text-2xl bg-red-500 text-white px-8 py-3 rounded-lg border-2 border-black hover:bg-red-600 active:translate-y-1 active:translate-x-1 active:shadow-none transition-all duration-150 pop-shadow-sm">
                    抓!
                </button>
            </div>
        </div>
        
        <div id="status" class="text-center my-6 font-bold"></div>
        
        <div id="slideshow-button-container" class="text-center my-6" style="display:none;">
            <button onclick="generateSlideshowHtml(extractedImageUrls)" class="font-pop text-xl bg-purple-500 text-white px-6 py-3 rounded-lg border-2 border-black hover:bg-purple-600 active:translate-y-1 active:translate-x-1 active:shadow-none transition-all duration-150 pop-shadow-sm">
                生成相簿 HTML 並下載!
            </button>
        </div>
        <div id="results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-10">
            </div>

    </div>

    <footer class="text-center p-6 mt-12">
        <p class="font-bold">Made by <a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline hover:text-pink-500">阿剛老師</a></p>
    </footer>

    <script src="photo.js"></script> 
    
    <script>
        // 取得頁面上的元素
        const urlInput = document.getElementById('gdoc-url');
        const resultsContainer = document.getElementById('results');
        const statusDiv = document.getElementById('status');
        const slideshowButtonContainer = document.getElementById('slideshow-button-container');
        
        // 步驟 2: 宣告全域變數以儲存網址，供 photo.js 呼叫
        let extractedImageUrls = []; 

        urlInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 防止表單提交
                extractImages();
            }
        });

        async function extractImages() {
            const url = urlInput.value.trim();
            if (!url) {
                showStatus('網址欄...是空的喔！', 'error');
                return;
            }

            // 清空先前的結果、圖片網址列表並隱藏相簿按鈕
            resultsContainer.innerHTML = '';
            extractedImageUrls = []; // 清空圖片網址列表
            slideshowButtonContainer.style.display = 'none'; // 隱藏按鈕
            showStatus('<div class="loader mx-auto"></div><p class="mt-2 font-pop text-2xl">尋找中...</p>', 'loading');

            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`網路錯誤: ${response.status} ${response.statusText}`);
                }
                
                const htmlText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                const images = doc.querySelectorAll('img');

                if (images.length === 0) {
                    showStatus('這個網址裡...一張圖都沒有耶。', 'info');
                    return;
                }

                statusDiv.innerHTML = '';

                let imageCount = 0;
                images.forEach(img => {
                    const src = img.src;
                    if (src && src.includes('googleusercontent.com')) {
                        imageCount++;
                        extractedImageUrls.push(src); // 儲存圖片網址
                        createImageCard(src);
                    }
                });
                
                if (imageCount === 0) {
                     showStatus('嗯...找不到 Google 文件的圖片喔。', 'info');
                } else {
                     showStatus(`讚啦！找到 ${imageCount} 張圖片！`, 'success');
                     // 顯示相簿按鈕，傳遞 extractedImageUrls 給 generateSlideshowHtml
                     slideshowButtonContainer.style.display = 'block';
                }


            } catch (error) {
                console.error('提取過程中發生錯誤:', error);
                showStatus(`抓取失敗！<br><small class="font-normal">請檢查網址是否正確，且已「發佈到網路」。</small>`, 'error');
            }
        }

        function createImageCard(src) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg border-4 border-black pop-shadow overflow-hidden transform hover:-translate-y-2 transition-transform duration-200';

            const thumbnail = document.createElement('img');
            thumbnail.src = src;
            thumbnail.alt = '提取的圖片';
            thumbnail.className = 'w-full h-40 object-contain bg-gray-100 p-2 border-b-4 border-black';
            thumbnail.loading = 'lazy';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'p-3 bg-cyan-300';

            const urlInput = document.createElement('input');
            urlInput.type = 'text';
            urlInput.value = src;
            urlInput.readOnly = true;
            urlInput.className = 'w-full p-2 mb-2 text-xs border-2 border-black rounded bg-white';

            const copyButton = document.createElement('button');
            copyButton.textContent = '複製網址';
            copyButton.className = 'w-full bg-yellow-300 text-black font-bold px-3 py-2 text-sm rounded border-2 border-black hover:bg-yellow-400 active:bg-yellow-500 transition';
            
            copyButton.onclick = (e) => {
                e.target.disabled = true;
                urlInput.select();
                // 檢查瀏覽器是否支援
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(urlInput.value).then(() => {
                         e.target.textContent = '複製成功!';
                        e.target.classList.remove('bg-yellow-300');
                        e.target.classList.add('bg-green-400');
                        
                        setTimeout(() => {
                            e.target.textContent = '複製網址';
                            e.target.classList.remove('bg-green-400');
                            e.target.classList.add('bg-yellow-300');
                            e.target.disabled = false;
                        }, 2000);
                    }).catch(err => {
                        // 舊的備用方法
                        urlInput.select();
                        document.execCommand('copy');
                         e.target.textContent = '複製成功!';
                        e.target.classList.remove('bg-yellow-300');
                        e.target.classList.add('bg-green-400');
                        
                        setTimeout(() => {
                            e.target.textContent = '複製網址';
                            e.target.classList.remove('bg-green-400');
                            e.target.classList.add('bg-yellow-300');
                            e.target.disabled = false;
                        }, 2000);
                    });
                } else {
                    // 舊的備用方法
                    urlInput.select();
                    document.execCommand('copy');
                    e.target.textContent = '複製成功!';
                    e.target.classList.remove('bg-yellow-300');
                    e.target.classList.add('bg-green-400');
                    
                    setTimeout(() => {
                        e.target.textContent = '複製網址';
                        e.target.classList.remove('bg-green-400');
                        e.target.classList.add('bg-yellow-300');
                        e.target.disabled = false;
                    }, 2000);
                }
            };

            infoDiv.appendChild(urlInput);
            infoDiv.appendChild(copyButton);
            card.appendChild(thumbnail);
            card.appendChild(infoDiv);
            
            resultsContainer.appendChild(card);
        }

        function showStatus(message, type) {
            let styleClass = '';
            switch (type) {
                case 'error':
                    styleClass = 'text-white bg-red-500 border-black';
                    break;
                case 'success':
                    styleClass = 'text-black bg-green-400 border-black';
                    break;
                case 'info':
                    styleClass = 'text-black bg-blue-300 border-black';
                    break;
                case 'loading':
                     statusDiv.innerHTML = message;
                     return;
            }
            statusDiv.innerHTML = `<div class="p-4 rounded-lg border-4 pop-shadow-sm ${styleClass}">${message}</div>`;
        }
    </script>
</body>
</html>
